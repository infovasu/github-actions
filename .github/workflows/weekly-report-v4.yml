name: Weekly Report

on:
  # Runs automatically every Monday at 9:00 UTC
  schedule:
    - cron: "0 9 * * MON"
  # Allows you to run it manually from the Actions tab
  workflow_dispatch:

jobs:
  create-weekly-report:
    runs-on: ubuntu-latest

    steps:
      - name: Generate and create weekly report issue
        uses: actions/github-script@v7
        with:
          script: |
            const { github, context } = require("@actions/github");

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // ----- Calculate last 7 days range -----
            const today = new Date();
            const endDate = today.toISOString().split("T")[0];

            const lastWeek = new Date();
            lastWeek.setDate(today.getDate() - 7);
            const startDate = lastWeek.toISOString().split("T")[0];

            // ----- Fetch issues created in last 7 days -----
            const created = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue created:${startDate}..${endDate}`
            });

            // ----- Fetch issues closed in last 7 days -----
            const closed = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue closed:${startDate}..${endDate}`
            });

            // ----- Build a simple markdown report -----
            const createdList = created.data.items
              .map(i => `- #${i.number} â€“ ${i.title}`)
              .join("\n") || "_None_";

            const closedList = closed.data.items
              .map(i => `- #${i.number} â€“ ${i.title}`)
              .join("\n") || "_None_";

            const body = `
### ğŸ“ Weekly Report (${startDate} â†’ ${endDate})

#### Summary
- Issues created: **${created.data.total_count}**
- Issues closed: **${closed.data.total_count}**

---

#### Created Issues
${createdList}

---

#### Closed Issues
${closedList}

---

_Report generated automatically by GitHub Actions._
`;

            // ----- Create the weekly report issue -----
            await github.rest.issues.create({
              owner,
              repo,
              title: `Weekly Report â€“ ${endDate}`,
              body,
              assignees: ["infovasu"]  
              // You can also add labels: ['report', 'weekly'] if you want
            });
